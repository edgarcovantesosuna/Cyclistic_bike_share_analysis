---
title: "Cyclistic bike-share analysis"
author: "Edgar Covantes Osuna"
date: "2024-04-04"
output:
  pdf_document: default
  html_document: default
---

## Content

This R markdown document contains a solution for the Google Data Analytics Capstone: Complete a Case Study, as part of the [Google Data Analytics Professional Certificate](https://www.coursera.org/professional-certificates/google-data-analytics).

The task titled "Case Study 1: How does a bike-share navigate speedy success?" consists of analyzing a case similar to what you might be asked for in a job interview.

In the following we will present a solution using the Python programming language and we will detailed the process followed to solve the case study.

## Scenario

The scenario is based on a fictional company called Cyclistic, a bike-share company in Chicago. The **hypothesis** is that the director believes the company's future success depends on maximizing the number of annual memberships.

To do this, it is necessary to understand how the different customers behave, for this we need to study how *casual riders* (customers who purchase single-ride or full-day passes) and *annual members* (customers who purchase annual memberships) use Cyclistic bikes differently.

The **goal** for the team is to design a new marketing strategy to convert casual riders into annual members. And to achieve such goal the team has defined the following research questions that will guide the analysis:

1.  How do annual members and casual riders use Cyclistic bikes differently?

2.  Why would casual riders buy Cyclistic annual memberships?

3.  How can Cyclistic use digital media to influence casual riders to become members?

In this case, we will focus on the first question, provide insights about the different habits of casual riders and annual members using Cyclistic bikes.

## Obtaining the data set

We have used Cyclistic's historical trip data to analyze and identify trends. For this we have make use of the information contained in the following ZIP files ([available here](https://divvy-tripdata.s3.amazonaws.com/index.html)):

| ZIP file names          | Date Modified              | Size     |
|:------------------------|:---------------------------|:---------|
| Divvy_Trips_2019_Q1.zip | Nov 8th 2021, 04:05:26 pm  | 9.57 MB  |
| Divvy_Trips_2019_Q2.zip | Nov 8th 2021, 04:06:12 pm  | 28.72 MB |
| Divvy_Trips_2019_Q3.zip | Jan 24th 2020, 10:08:06 am | 42.36 MB |
| Divvy_Trips_2019_Q4.zip | Jan 24th 2020, 10:08:07 am | 18.40 MB |
| Divvy_Trips_2020_Q1.zip | May 26th 2020, 07:17:43 pm | 15.92 MB |

The reason we have chosen those files is to have the newest information for the analysis, the complete 2019 information, plus the 2020 Q1.

## Loading libraries

Next we define a few libraries what we will need through the whole project.

```{r loading libraries}
# Collection of R libraries designed for data science
library(tidyverse)

# Package used to manage conflicts (manage ambiguity with packages)
library(conflicted)

# Package for declaratively creating graphics
library(ggplot2)

# Package used to provide cross-platform interface to file system operations
library(fs)

# Package for totally ordered indexed observations
library(zoo)

# Declaring filter and lag from the package dplyr as default choices
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
```

## Loading data-sets

Before we start working on the downloaded data-sets, let us first detailed how we have defined our work-space:

```{r workspace structure}
dir_tree(path = ".")
```

The current folder contains several files and sub-folders used in the present analysis. Among the files included, there is a PDF containing the information related to the case study, the history and background. Aside from the present R markdown file (RMD), a Jupiter Notebook (IPYND) that solves the same case study (but using the programming language R) is provided. A folder called `dataset` can be found containing the CSV files to be analyzed, another sub-folder called `original_data` that contains the downloaded ZIP files (just in case we needed to restore/use the original data sets' information). Finally, a folder called `reports` where all the final reports are stored.

Now, we can load the CSV files corresponding to 2019 Q1, Q2, Q3, Q4, and 2020 Q1.

```{r loading datasets}
q1_2019 <- read_csv("dataset/Divvy_Trips_2019_Q1.csv")
q2_2019 <- read_csv("dataset/Divvy_Trips_2019_Q2.csv")
q3_2019 <- read_csv("dataset/Divvy_Trips_2019_Q3.csv")
q4_2019 <- read_csv("dataset/Divvy_Trips_2019_Q4.csv")
q1_2020 <- read_csv("dataset/Divvy_Trips_2020_Q1.csv")
```

When observing the output provided by R from running the previous code chunk we can see that the data-frame `q1_2020` has 13 columns while the others have 12. Another difference is that data-frame `q1_2020` has different column names than all data-frames corresponding to 2019, and `q2_2019` has a complete different naming convention.

Here is the complete list of column names for all data-frames:

```{r column names}
colnames(q1_2019)
colnames(q2_2019)
colnames(q3_2019)
colnames(q4_2019)
colnames(q1_2020)
```

## Transforming the data-frames

So before we can use the data we need to homogenize the naming conventions of all data-frames. To do so, we will make use of the naming conventions of the newest `q1_2020` data-frame (when applicable), otherwise we will make use of the `q4_2019` data-frame. For more information about the equivalent columns in each data-frame you can check the following table, also we will remove some columns that do not provide meaningful contributions to our research question.

| Q1 2020              | Q1/Q3/Q4 2019       | Q2 2019                                            | To be removed |
|:--------------|:--------------|:----------------------------|:-------------:|
| `ride_id`            | `trip_id`           | `01 - Rental Details Rental ID`                    |               |
| `rideable_type`      | `bikeid`            | `01 - Rental Details Bike ID`                      |               |
| `started_at`         | `start_time`        | `01 - Rental Details Local Start Time`             |               |
| `ended_at`           | `end_time`          | `01 - Rental Details Local End Time`               |               |
| `start_station_name` | `from_station_name` | `03 - Rental Start Station Name`                   |               |
| `start_station_id`   | `from_station_id`   | `03 - Rental Start Station ID`                     |               |
| `end_station_name`   | `to_station_name`   | `02 - Rental End Station Name`                     |               |
| `end_station_id`     | `to_station_id`     | `02 - Rental End Station ID`                       |               |
| `member_casual`      | `usertype`          | `User Type`                                        |               |
| `start_lat`          |                     |                                                    |       ✘       |
| `start_lng`          |                     |                                                    |       ✘       |
| `end_lat`            |                     |                                                    |       ✘       |
| `end_lng`            |                     |                                                    |       ✘       |
|                      | `tripduration`      | `01 - Rental Details Duration In Seconds Uncapped` |       ✘       |
|                      | `gender`            | `Member Gender`                                    |       ✘       |
|                      | `birthyear`         | `05 - Member Details Member Birthday Year`         |       ✘       |

Let us start by renaming the columns of the `q1_2019`, `q2_2019`, `q3_2019`, `q4_2019` data-frames with the names in `q1_2020` data-frame.

```{r}
q1_2019 <- rename(q1_2019,
                  ride_id = trip_id,
                  rideable_type = bikeid,
                  started_at = start_time,
                  ended_at = end_time,
                  start_station_name = from_station_name,
                  start_station_id = from_station_id,
                  end_station_name = to_station_name,
                  end_station_id = to_station_id,
                  member_casual = usertype)

# q1_2020 does not have tripdurarion, gender and birthyear columns, so we use the names in q4_2019
q2_2019 <- rename(q2_2019,
                  ride_id = "01 - Rental Details Rental ID",
                  rideable_type = "01 - Rental Details Bike ID",
                  tripduration = "01 - Rental Details Duration In Seconds Uncapped", 
                  started_at = "01 - Rental Details Local Start Time",
                  ended_at = "01 - Rental Details Local End Time",
                  start_station_name = "03 - Rental Start Station Name",
                  start_station_id = "03 - Rental Start Station ID",
                  end_station_name = "02 - Rental End Station Name",
                  end_station_id = "02 - Rental End Station ID",
                  member_casual = "User Type",
                  gender = "Member Gender",
                  birthyear = "05 - Member Details Member Birthday Year")

q3_2019 <- rename(q3_2019,
                  ride_id = trip_id,
                  rideable_type = bikeid,
                  started_at = start_time,
                  ended_at = end_time,
                  start_station_name = from_station_name,
                  start_station_id = from_station_id,
                  end_station_name = to_station_name,
                  end_station_id = to_station_id,
                  member_casual = usertype)

q4_2019 <- rename(q4_2019,
                  ride_id = trip_id,
                  rideable_type = bikeid,
                  started_at = start_time,
                  ended_at = end_time,
                  start_station_name = from_station_name,
                  start_station_id = from_station_id,
                  end_station_name = to_station_name,
                  end_station_id = to_station_id,
                  member_casual = usertype)
```

Let us double-check that the changes we properly applied:

```{r review structure}
str(q1_2019)
str(q2_2019)
str(q3_2019)
str(q4_2019)
str(q1_2020)
```

Now based on the information obtained from the previous code chunk, two observations can be made. First, since all the previous data-frames will be merged to form a complete data-frame, we need all columns have the same data-type. Columns `ride_id` and `rideable_type` from the 2019 data-frames do not share the same type as the 2020 (`num` and `chr`, respectively). We will need to fix this before we can combine the data. Second, the column `member_casual` in `q1_2020` has two values: `member` and `casual`, while all data-frames from 2019 have the values: `Subscriber` and `Customer`. We will get back to this once we have solved the first observation.

Then, let us change the data-type from all data-frames from 2019 to the ones in 2020.

```{r change data-type}
q1_2019 <- mutate(q1_2019, 
                  ride_id = as.character(ride_id),
                  rideable_type = as.character(rideable_type))

q2_2019 <- mutate(q2_2019, 
                  ride_id = as.character(ride_id),
                  rideable_type = as.character(rideable_type))

q3_2019 <- mutate(q3_2019, 
                  ride_id = as.character(ride_id),
                  rideable_type = as.character(rideable_type))

q4_2019 <- mutate(q4_2019, 
                  ride_id = as.character(ride_id),
                  rideable_type = as.character(rideable_type))
```

Now we can combine all data-frames into a single huge one.

```{r merging data-frames}
all_trips <- bind_rows(q1_2019, q2_2019, q3_2019, q4_2019, q1_2020)
```

Once we have our full data-frame let us remove the columns that do not help on answering the research question (see table above).

```{r removing columns}
all_trips <- all_trips %>% 
  select(-c(tripduration, gender, birthyear, start_lat, start_lng, end_lat, end_lng))
```

For the sake of completeness let us review some details of the `all_trips` data-frame, such as column names:

```{r all_trips colnames}
colnames(all_trips)
```

Dimensions of the `all_trips` data-frame (rows, column):

```{r all_trips dimension}
dim(all_trips)
```

First 6 rows of the `all_trips` data-frame:

```{r all_trips head}
head(all_trips)
```

Structure of the `all_trips` data-frame:

```{r all_trips structure}
str(all_trips)
```

Finally, a summary of the content of the `all_trips` data-frame:

```{r all_trips summary}
summary(all_trips)
```

## Cleaning the data

Now, recall that previously we have made the observation "the column `member_casual` in `q1_2020` has two values: `member` and `casual`, while all data-frames from 2019 have the values: `Subscriber` and `Customer`". Let us check first how many rows we have for each member type:

```{r all_trips all_members}
table(all_trips$member_casual)
```

Based on the scenario nomenclature and the `q1_2020` data-frame we will change the members type of `Customer` and `Subcriber`, to `casual` and `member`, respectively, and we check that the resulting values correspond to the proper members amount.

```{r all_trips fixed_members}
all_trips <- all_trips %>% 
  mutate(member_casual = recode(member_casual, "Subscriber" = "member", "Customer" = "casual"))

table(all_trips$member_casual)
```

Recall that, `all_trips` data-frame had a column called `tripduration` that was removed. We removed this column because `q1_2020` data-frame did not had that column, and the others had it. In the following somehow we will recover this information by creating a calculated column using `started_at` and `ended_at` columns.

In the mean time, since we need information related to the members trips, and we need easier dates information than the ones provided by the `started_at` column, we will create five more columns called `date`, `month`, `day`, `year` and `day_of_week` with information extracted from `started_at`.

```{r create date columns}
all_trips$date <- as.Date(all_trips$started_at)
all_trips$month <- format(as.Date(all_trips$date), "%B")
all_trips$day <- format(as.Date(all_trips$date), "%d")
all_trips$year <- format(as.Date(all_trips$date), "%Y")
all_trips$day_of_week <- format(as.Date(all_trips$date), "%A")
```

We do not need to process column `ended_at` since by calculating the trip duration we can obtain the information related to when the trip finished, with that in mind (and as mentioned before) we create the column `ride_length` to register how much time a trip was in seconds.

```{r create ride_length col}
all_trips$ride_length <- difftime(all_trips$ended_at, all_trips$started_at)
```

Let us check the resulting structure of the `all_trips`.

```{r all_trips structure new_cols}
str(all_trips)
```

Now, let us convert the `ride_length` column to numeric so we can make calculations with it. Then we show a summary for the `all_trips` complete data-frame.

```{r ride_length to_num}
all_trips$ride_length <- as.numeric(as.character(all_trips$ride_length))
is.numeric(all_trips$ride_length)
summary(all_trips)
```

Based on the summary for the column `ride_length` we have negative time measurements, this is not possible (as far as I know), so there must be a problem with this information. One possible reason for this behavior may correspond to events in which some bikes were taken out of docks for maintenance, i.e., bikes with `start_station_name=HQ QR` or some problem related to the time register.

In any case we cannot use this information, so we will remove the rows containing `start_station_name = HQ QR` or `ride_length < 0`.

```{r remove bad_data}
all_trips_v2 <- all_trips[!(all_trips$start_station_name == 'HQ QR' | all_trips$ride_length < 0),]
```

With this, we have obtained a new data-frame called `all_trips_v2` with 3780 rows less than `all_trips`.

```{r diff all_trips all_trips_v2}
nrow(all_trips) - nrow(all_trips_v2)
```

## Descriptive analysis

Now that we have cleaned the data we are ready to focus on answering the research question "**How do annual members and casual riders use Cyclistic bikes differently?**". Since the question focuses on time using the bikes, let us check some descriptive statistics for the `ride_length` column.

```{r descriptive statistics}
summary(all_trips_v2$ride_length)
```

Let us start exploring the ride time between annual members vs. casual riders. In the following we obtain some descriptive statistics such as mean, median, max and min.

```{r ride_length members desc_statistics}
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = mean)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = median)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = max)
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual, FUN = min)
```

In general, from the descriptive statistics, on average, we can observe that casual riders are more dominant in the usage of Cyclistic bikes than annual members. Next, let us see if there is a preference between users depending the month.

```{r plot rides year month riders_type}
all_trips_v2 %>% 
  mutate(year_month = as.yearmon(all_trips_v2$date)) %>% 
  group_by(member_casual, year_month) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, year_month) 
```

Now, we can plot the information.

```{r}
all_trips_v2 %>% 
  mutate(year_month = as.yearmon(all_trips_v2$date)) %>% 
  group_by(member_casual, year_month) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, year_month) %>%  
  ggplot(aes(x = as.Date(year_month), y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge", stat = "identity") +
  scale_x_date(date_breaks="1 month", date_labels="%Y-%B", expand=c(0,0)) +
  labs(title = 'Number of rides by year-month and riders type',
       x = 'Year-Month',
       y = 'Number of Rides') +
  theme(axis.text.x = element_text(angle = 90))
```

Clearly, annual members use more Cyclistic bikes, than casual riders, with August being the month with more demand, followed by July, and September.

Now, let us focus on the average duration of the trips.

```{r}
all_trips_v2 %>% 
  mutate(year_month = as.yearmon(all_trips_v2$date)) %>% 
  group_by(member_casual, year_month) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, year_month) %>%  
  ggplot(aes(x = as.Date(year_month), y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge", stat = "identity") +
  scale_x_date(date_breaks="1 month", date_labels="%Y-%B", expand=c(0,0)) +
  labs(title = 'Average duration of rides by year-month and riders type',
       x = 'Year-Month',
       y = 'Average duration (seconds)') +
  theme(axis.text.x = element_text(angle = 90))
```

The new graph now shows that casual riders on average, they take longer trips than annual members, being the beginning of each year the most the most busiest season.

So far, all suggest that casual riders take longer rides compared to annual members during all year, but annual members perform more rides with shorter rides.

Finally, let us see if there is a preference between users depending the day of the week. But first let us order the days of the week starting from Sunday and finishing on Saturday, this will make the visualization easier.

```{r order all_trips_v2 day_of_week}
all_trips_v2$day_of_week <- ordered(all_trips_v2$day_of_week, levels=c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
```

Now, let us see the average ride time between annual members vs. casual members.

```{r mean ride_length members day_of_week}
aggregate(all_trips_v2$ride_length ~ all_trips_v2$member_casual + all_trips_v2$day_of_week, FUN = mean)
```

So far, the quantities suggest longer rides from casual riders on most days of the week compared to annual members. But, does this means that casual riders use more bikes than annual members? Now, let us add to the previous analysis the number of rides to see if longer rides means more usage of bikes.

```{r members weekday number_rides avg_ride_length}
all_trips_v2 %>% 
  mutate(weekday = all_trips_v2$day_of_week) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)
```

The previous result suggest that it is true that casual riders perform longer rides than the annual members but it seems, based on the number of rides, that annual members use more the bikes than the casual riders, but with shorter trips.

One hypothesis that could explain this behavior is that annual members use the bikes services as their main transportation, i.e., they use this service to go from one point to another in well defined routes, e.g., going to the nearest station from home, to the nearest station from work. If this is done repeatedly makes sense to pay for a subscription.

But casual riders they may not need to go for specific routes, they may be more interested on going to longer trips doing tourism, making several stops during the day, this makes sense when we observe that casual riders make more trips during the weekends.

Now, let us show the previous results but using a column chart so we can easily check if there is a trend in the data.

```{r plot rides weekday riders_type}
all_trips_v2 %>% 
  mutate(weekday = all_trips_v2$day_of_week) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday) %>% 
  ggplot(aes(x = weekday, y = number_of_rides, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = 'Number of rides by weekday and riders type',
       x = 'Weekdays',
       y = 'Number of Rides')
```

As the chart suggests, annual members clearly use more the bikes. Now, let us focus on the average duration of the trips.

```{r plot average rides weekday riders_type}
all_trips_v2 %>% 
  mutate(weekday = all_trips_v2$day_of_week) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday) %>% 
  ggplot(aes(x = weekday, y = average_duration, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = 'Average duration of rides by weekday and riders type',
       x = 'Weekdays',
       y = 'Average duration (seconds)')
```

Again, the previous chart also suggest longer trips be the casual riders than annual members, but fewer number of rides.

## Exporting final report

Finally, we export the final report that contemplates the number of rides, the average trip duration per member and weekday so we can easily visualize it using any spreadsheet software, Tableau, during a presentation, and/or reproduce the previous charts.

```{r final report}
counts_ym <- all_trips_v2 %>%
  mutate(year_month = as.yearmon(all_trips_v2$date)) %>% 
  group_by(member_casual, year_month) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, year_month)
write.csv(counts_ym, file = 'reports/year_month_number_rides_and_avg_ride_length_r.csv')

counts_wd <- all_trips_v2 %>%
  mutate(weekday = all_trips_v2$day_of_week) %>% 
  group_by(member_casual, weekday) %>% 
  summarise(number_of_rides = n(), average_duration = mean(ride_length)) %>% 
  arrange(member_casual, weekday)
write.csv(counts_wd, file = 'reports/week_day_number_rides_and_avg_ride_length_r.csv')
```
